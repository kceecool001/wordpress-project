name: Verify WordPress Deployment

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["WordPress Infra + App Deployment"]
    types:
      - completed

jobs:
  verify:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Get Terraform outputs
        id: tf_outputs
        working-directory: infra/envs/dev
        run: |
          terraform init -input=false
          TF_OUTPUTS=$(terraform output -json)
          
          BUCKET=$(echo "$TF_OUTPUTS" | jq -r '.s3_bucket_name.value')
          HOST=$(echo "$TF_OUTPUTS" | jq -r '.ec2_public_ip.value')
          DB=$(echo "$TF_OUTPUTS" | jq -r '.db_endpoint.value')
          ALB=$(echo "$TF_OUTPUTS" | jq -r '.alb_dns_name.value')
          EC2_ID=$(echo "$TF_OUTPUTS" | jq -r '.ec2_id.value')
          
          echo "bucket_name=$BUCKET" >> $GITHUB_OUTPUT
          echo "ec2_host=$HOST" >> $GITHUB_OUTPUT
          echo "db_endpoint=$DB" >> $GITHUB_OUTPUT
          echo "alb_dns_name=$ALB" >> $GITHUB_OUTPUT
          echo "ec2_id=$EC2_ID" >> $GITHUB_OUTPUT

      - name: 1. Verify S3 Bucket Access
        run: |
          echo "=== Verifying S3 Bucket ==="
          if aws s3 ls s3://${{ steps.tf_outputs.outputs.bucket_name }} > /dev/null 2>&1; then
            echo "‚úÖ S3 bucket is accessible"
            echo "Files in bucket:"
            aws s3 ls s3://${{ steps.tf_outputs.outputs.bucket_name }}/
          else
            echo "‚ùå S3 bucket is NOT accessible"
            exit 1
          fi

      - name: 2. Verify EC2 Instance Status
        run: |
          echo "=== Verifying EC2 Instance ==="
          INSTANCE_STATE=$(aws ec2 describe-instances \
            --instance-ids ${{ steps.tf_outputs.outputs.ec2_id }} \
            --query 'Reservations[0].Instances[0].State.Name' \
            --output text)
          
          echo "Instance State: $INSTANCE_STATE"
          
          if [ "$INSTANCE_STATE" = "running" ]; then
            echo "‚úÖ EC2 instance is running"
          else
            echo "‚ùå EC2 instance is NOT running (State: $INSTANCE_STATE)"
            exit 1
          fi

      - name: 3. Verify EC2 Web Server via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ steps.tf_outputs.outputs.ec2_host }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Checking Apache Status ==="
            if sudo systemctl is-active httpd > /dev/null 2>&1; then
              echo "‚úÖ Apache is running"
              sudo systemctl status httpd --no-pager | head -10
            else
              echo "‚ùå Apache is NOT running"
              exit 1
            fi
            
            echo ""
            echo "=== Checking Port 80 Locally ==="
            if sudo netstat -tulpn | grep -q :80; then
              echo "‚úÖ Apache is listening on port 80"
              sudo netstat -tulpn | grep :80
            else
              echo "‚ùå Nothing listening on port 80"
              exit 1
            fi
            
            echo ""
            echo "=== Testing Local HTTP Response ==="
            RESPONSE=$(curl -s -L http://localhost)
            HTTP_CODE=$(echo "$RESPONSE" | grep -oE "^[0-9]{3}" || curl -s -o /dev/null -w "%{http_code}" http://localhost)

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
               echo "‚úÖ Apache responding locally (HTTP $HTTP_CODE)"
            else
               echo "‚ùå Apache not responding properly (HTTP $HTTP_CODE)"
               exit 1
            fi

            echo ""
            echo "=== Checking WordPress Indicators ==="
            if echo "$RESPONSE" | grep -qi "wp-content\|wp-includes\|WordPress"; then
               echo "‚úÖ WordPress markers found in response"
            else
               echo "‚ö†Ô∏è No WordPress markers found ‚Äî site may not be configured yet"
            fi
            
            echo ""
            echo "=== Checking WordPress Files on Disk ==="
            if [ -f "/var/www/html/index.php" ]; then
               echo "‚úÖ index.php exists at /var/www/html"
            else
               echo "‚ùå index.php missing at /var/www/html"
               sudo ls -la /var/www/html
               exit 1
            fi

      - name: 4. Verify RDS Database Connectivity
        run: |
          echo "=== Verifying RDS Database ==="
          DB_HOST=$(echo "${{ steps.tf_outputs.outputs.db_endpoint }}" | cut -d':' -f1)
          DB_PORT=$(echo "${{ steps.tf_outputs.outputs.db_endpoint }}" | cut -d':' -f2)
          
          echo "Database Host: $DB_HOST"
          echo "Database Port: $DB_PORT"
          
          DB_STATUS=$(aws rds describe-db-instances \
            --query 'DBInstances[?Endpoint.Address==`'$DB_HOST'`].DBInstanceStatus' \
            --output text)
          
          echo "Database Status: $DB_STATUS"
          
          if [ "$DB_STATUS" = "available" ]; then
            echo "‚úÖ RDS database is available"
          else
            echo "‚ùå RDS database is NOT available (Status: $DB_STATUS)"
            exit 1
          fi

      - name: 5. Verify Target Group Health
        run: |
          echo "=== Verifying Target Group Health ==="
          
          # Get target group ARN
          TG_ARN=$(aws elbv2 describe-target-groups \
            --query 'TargetGroups[?contains(TargetGroupName, `wordpress`) || contains(TargetGroupName, `dev`)].TargetGroupArn' \
            --output text | head -n1)
          
          if [ -z "$TG_ARN" ]; then
            echo "‚ùå Target group not found"
            exit 1
          fi
          
          echo "Target Group ARN: $TG_ARN"
          
          # Check if EC2 is registered
          REGISTERED=$(aws elbv2 describe-target-health \
            --target-group-arn $TG_ARN \
            --query 'TargetHealthDescriptions[?Target.Id==`${{ steps.tf_outputs.outputs.ec2_id }}`]' \
            --output json)
          
          if [ "$REGISTERED" = "[]" ]; then
            echo "‚ùå EC2 instance is NOT registered in target group"
            echo "Attempting to register..."
            
            # Try to find and register
            TG_ARN_LIST=$(aws elbv2 describe-target-groups \
              --query 'TargetGroups[].TargetGroupArn' \
              --output text)
            
            for TG in $TG_ARN_LIST; do
              echo "Checking target group: $TG"
              aws elbv2 register-targets \
                --target-group-arn $TG \
                --targets Id=${{ steps.tf_outputs.outputs.ec2_id }} 2>/dev/null || true
            done
            
            echo "‚ö†Ô∏è  Registration attempted. Please verify manually or run Terraform apply."
          else
            echo "‚úÖ EC2 instance is registered in target group"
          fi
          
          # Wait for health check
          echo "Waiting 30 seconds for health check..."
          sleep 30
          
          # Check health status
          HEALTH_STATUS=$(aws elbv2 describe-target-health \
            --target-group-arn $TG_ARN \
            --targets Id=${{ steps.tf_outputs.outputs.ec2_id }} \
            --query 'TargetHealthDescriptions[0].TargetHealth.State' \
            --output text 2>/dev/null || echo "unknown")
          
          echo "Target Health Status: $HEALTH_STATUS"
          
          if [ "$HEALTH_STATUS" = "healthy" ]; then
            echo "‚úÖ Target is healthy"
          elif [ "$HEALTH_STATUS" = "initial" ]; then
            echo "‚ö†Ô∏è  Target is in initial state (health checks in progress)"
          else
            echo "‚ö†Ô∏è  Target health status: $HEALTH_STATUS"
            echo "This may be expected if the instance was just launched."
          fi

      - name: 6. Verify ALB Endpoint
        run: |
          echo "=== Verifying ALB Endpoint ==="
          MAX_ATTEMPTS=15
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT+1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            HTTP_CODE=$(curl -f -s -o /dev/null -w "%{http_code}" http://${{ steps.tf_outputs.outputs.alb_dns_name }} || echo "000")
            
            if echo "$HTTP_CODE" | grep -q "200\|301\|302"; then
              echo "‚úÖ ALB is responding (HTTP $HTTP_CODE)"
              echo ""
              echo "=== Response Headers ==="
              curl -I http://${{ steps.tf_outputs.outputs.alb_dns_name }}
              break
            else
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "‚ùå ALB is NOT responding properly after $MAX_ATTEMPTS attempts (HTTP $HTTP_CODE)"
                exit 1
              fi
              echo "ALB returned HTTP $HTTP_CODE, waiting 15 seconds before retry..."
              sleep 15
            fi
          done

      - name: 7. Test WordPress Specifics
        run: |
          echo "=== Testing WordPress Application ==="
          
          # Check for WordPress indicators
          RESPONSE=$(curl -s -L http://${{ steps.tf_outputs.outputs.alb_dns_name }})
          
          echo "Checking for WordPress indicators..."
          
          if echo "$RESPONSE" | grep -qi "wordpress\|wp-content\|wp-includes"; then
            echo "‚úÖ WordPress indicators found in response"
          else
            echo "‚ö†Ô∏è  WordPress indicators not found (might not be configured yet)"
          fi
          
          # Test wp-content directory
          echo ""
          echo "Testing wp-content directory..."
          WP_CONTENT_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ steps.tf_outputs.outputs.alb_dns_name }}/wp-content/ 2>/dev/null)
          if [ "$WP_CONTENT_CODE" -eq 403 ] || [ "$WP_CONTENT_CODE" -eq 200 ]; then
            echo "‚úÖ wp-content directory accessible (HTTP $WP_CONTENT_CODE)"
          else
            echo "‚ö†Ô∏è  wp-content directory returned HTTP $WP_CONTENT_CODE"
          fi
          
          # Test wp-admin
          echo ""
          echo "Testing wp-admin..."
          WP_ADMIN_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L http://${{ steps.tf_outputs.outputs.alb_dns_name }}/wp-admin/ 2>/dev/null)
          if [ "$WP_ADMIN_CODE" -eq 200 ] || [ "$WP_ADMIN_CODE" -eq 302 ]; then
            echo "‚úÖ wp-admin accessible (HTTP $WP_ADMIN_CODE)"
          else
            echo "‚ö†Ô∏è  wp-admin returned HTTP $WP_ADMIN_CODE"
          fi    

      - name: 8. Performance Test
        run: |
          echo "=== Performance Testing ==="
          
          echo "Testing response times (10 requests)..."
          TOTAL=0
          SUCCESS_COUNT=0
          
          for i in {1..10}; do
            TIME=$(curl -o /dev/null -s -w "%{time_total}" http://${{ steps.tf_outputs.outputs.alb_dns_name }} 2>/dev/null || echo "0")
            if [ "$TIME" != "0" ]; then
              echo "Request $i: ${TIME}s"
              TOTAL=$(echo "$TOTAL + $TIME" | bc)
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "Request $i: Failed"
            fi
            sleep 1
          done
          
          if [ $SUCCESS_COUNT -gt 0 ]; then
            AVG=$(echo "scale=3; $TOTAL / $SUCCESS_COUNT" | bc)
            echo ""
            echo "Average response time: ${AVG}s"
            
            # Check if average is reasonable
            if (( $(echo "$AVG < 3" | bc -l) )); then
              echo "‚úÖ Performance is good"
            else
              echo "‚ö†Ô∏è  Performance could be better (average > 3s)"
            fi
          else
            echo "‚ùå All requests failed"
            exit 1
          fi

      - name: 9. Test End-to-End Connectivity
        run: |
          echo "=== Testing End-to-End Connectivity ==="
          
          # Test direct EC2 access
          echo "Testing direct EC2 access..."
          EC2_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ steps.tf_outputs.outputs.ec2_host }})
          echo "EC2 Direct Response: HTTP $EC2_RESPONSE"
          
          # Test ALB access
          echo "Testing ALB access..."
          ALB_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ steps.tf_outputs.outputs.alb_dns_name }})
          echo "ALB Response: HTTP $ALB_RESPONSE"
          
          # Compare responses
          if [ "$EC2_RESPONSE" = "$ALB_RESPONSE" ]; then
            echo "‚úÖ ALB is correctly routing to EC2"
          else
            echo "‚ö†Ô∏è  Response codes differ (EC2: $EC2_RESPONSE, ALB: $ALB_RESPONSE)"
            echo "This might indicate routing issues"
          fi

      - name: Generate Deployment Report
        if: always()
        run: |
          echo "==================================="
          echo "   DEPLOYMENT VERIFICATION REPORT"
          echo "==================================="
          echo ""
          echo "üåê Endpoints:"
          echo "   ALB URL: http://${{ steps.tf_outputs.outputs.alb_dns_name }}"
          echo "   EC2 URL: http://${{ steps.tf_outputs.outputs.ec2_host }}"
          echo ""
          echo "üì¶ Resources:"
          echo "   S3 Bucket: ${{ steps.tf_outputs.outputs.bucket_name }}"
          echo "   EC2 Instance: ${{ steps.tf_outputs.outputs.ec2_id }}"
          echo "   Database: ${{ steps.tf_outputs.outputs.db_endpoint }}"
          echo ""
          echo "==================================="
          echo ""
          echo "üîó Access your WordPress site at:"
          echo "   http://${{ steps.tf_outputs.outputs.alb_dns_name }}"
          echo "==================================="